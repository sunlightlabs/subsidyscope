{% extends "base.html" %}
{% load media %}
{% load morsel_tags %}
{% load webdesign %}
{% load humanize %}
{% load search_tags %}
{% load sector_tags %}
 

{% block additional_css %}
  {% css "styles/jquery-ui/ui.all.css" %}
  {% css "styles/faads-search.css" %}
{% endblock %}

{% block additional_js %}

	{% js "scripts/ui.core.js" %}
	{% js "scripts/ui.tabs.js" %}
	{% js "scripts/ui.datepicker.js" %}

    {% js "scripts/jquery.ba-bbq.min.js" %}
	
	{% js "scripts/swfobject.js" %}
	{% js "scripts/faads-search.js?version=5" %}
	

<!-- if JS is enabled, assume that the tabs will work and hide the other divs -->
<script language="javascript" type="text/javascript">
	document.write('<style type="text/css">.program-selection-target { display: none; }</style>');
</script>


<script>

var sortColumn = '{{ sort_column }}';
var sortOrder = '{{ sort_order }}'; 

</script>
	
{% endblock %}

{% load menubuilder %}
{% block content %}

<div class="wrapper clearfix">	
	<div class="secondary-header">
            <a id="screencast-link-container" href="{% url screencast %}">Need help? Watch the screencast.</a>
			<h3>{% morsel_sector_title %}</h3>
			
        </div>
	    {% recursive_menu %}

        <div class="page-content">    
	<h2>{% morsel_page_title %} (FY 2000&ndash;2010)</h2>
					<p>{% morsel text1 %}</p>

              <p id="sector-changing" style="display: none;"></p>
	
					<form action="{{ page_path }}" method="POST" id="faads-search-form">



          <fieldset id="advanced-options" {% if ran_search %}class="collapsed"{% endif %}>

            <legend id="advanced-options">Search Options <a class="state" href="#" id="search-options-state"></a></legend>

              <h4> Economic Sector </h4>

              {{ form.sector_id }}

            {% if form.cfda_program_selection_method %}
	            <div class="section" id="programs">
	            <h4>Select Programs</h4>
	            
	            	<div id="cfda_selector_tabs" class="widget-no-border">
	            	
	            		{{ form.cfda_program_selection_method }}

			             <div id="program-selection-subsidy_programs" class="widget-header widget-no-padding">
			              {% morsel program_selection_subsidy_programs %}    
			              <div class="clear-left"></div>                    
			             </div>
			             
			           
			            <div id="program-selection-program" class="ui-tabs-panel">
			           
			              {% morsel program_selection_program %}

                          {% if form.program_selection_programs %}
                          <p class="select-all-or-none">[ <a href="#" class="select-all" id="program-selection-program-select-all">Select All</a> / <a href="#" class="select-none" id="program-selection-program-select-none">Select None</a> ]</p>
                          {% endif %}

                          {% if not form.program_selection_programs %}
                            <p>All Programs for Energy, Transportation, Nonprofits and Housing are currently selected. To filter by program, choose a sector above.</p>
                          {% endif %}
			              {{ form.program_selection_programs }}
			              {{ form.program_selection_programs.errors }}
			              <div class="clear-left"></div>
			            
			            </div>
			           
			            
			            {% if form.program_selection_subsector %}
			            <div id="program-selection-subsector" class="ui-tabs-panel">
			
			              {% morsel program_selection_subsector %}
			
			              <p class="select-all-or-none">[ <a href="#" class="select-all" id="program-selection-subsector-select-all">Select All</a> / <a href="#" class="select-none" id="program-selection-subsector-select-none">Select None</a> ]</p>
			
			              {{ form.program_selection_subsector }}
			              {{ form.program_selection_subsector.errors }}
			              <div class="clear-left"></div>
			            </div>
			            {% endif %}
			

			    	</div>
	            </div>
            {% endif %}
         
         	<div class="section" id="text">
         		<h4>Recipient Name / Project Description</h4>
         		
         			{% morsel full_text_search %}
         			
					<div id="text-query-text-wrapper">{{ form.text_query }}{{ form.text_query.errors }}</div>
					<div id="text-query-type-wrapper">{{ form.text_query_type }}{{ form.text_query_type.errors }}</div>
         
         	</div>
            
         
            <div class="section" id="type">
            <h4>Expenditure Type</h4>

  					<div class="field-wrapper" id="assistance-action-recipient-wrapper">
  						<div class="dropdown-wrapper" id="recipient-type">
  						  <label for="recipient_type">Recipient Type</label>&nbsp;<span class="select-all-or-none">[&nbsp;<a href="#" class="select-all" id="program-selection-subsector-select-all">All</a> / <a href="#" class="select-none" id="program-selection-subsector-select-none">None</a>&nbsp;]</span>
  							<div>{{ form.recipient_type }}</div>
  							{{ form.recipient_type.errors }}
  						</div>
						<div class="dropdown-wrapper">
  						  <label for="assistance_type">Assistance Type</label>&nbsp;<span class="select-all-or-none">[&nbsp;<a href="#" class="select-all" id="program-selection-subsector-select-all">All</a> / <a href="#" class="select-none" id="program-selection-subsector-select-none">None</a>&nbsp;]</span>
  							{{ form.assistance_type }}
  							{{ form.assistance_type.errors }}
  						</div>
  						<div class="dropdown-wrapper">
  						  <label for="action_type">Action Type</label>&nbsp;<span class="select-all-or-none">[&nbsp;<a href="#" class="select-all" id="program-selection-subsector-select-all">All</a> / <a href="#" class="select-none" id="program-selection-subsector-select-none">None</a>&nbsp;]</span>
  							{{ form.action_type }}
  							{{ form.action_type.errors }}
  						</div>

  					</div>		
  					<div class="clear-left"></div>
  				</div>
  					
  					
					
            <div class="section" id="range">
				  <h4>Expenditure Range</h4>
  					<div class="field-wrapper">
					<div id="obligation-date-wrapper">
					  <label for="obligation_date_start">Obligation Date</label>
					  <div class="range-wrapper">
  						{{ form.obligation_date_start }}<span class="range">to</span>{{ form.obligation_date_end }}
  						{{ form.obligation_date_start.errors }}
  						{{ form.obligation_date_end.errors }}
						</div>
						{# fiscal year ? #}
					</div>
				
					<div id="obligation-amount-wrapper">
					  <label for="obligation_amount_minimum">Obligation Amount</label>
					  <div class="range-wrapper">
  						$ {{ form.obligation_amount_minimum }}<span class="range">to</span>$ {{ form.obligation_amount_maximum }}
  						{{ form.obligation_amount_minimum.errors }}
  						{{ form.obligation_amount_maximum.errors }}
						</div>
					</div>
            	</div>
            </div>
            
            
            

          
          <div class="section last" id="location">
            <h4>Location</h4>
            
            <p>You may filter records by the location of either the recipient or the location where the activity associated with the expenditure was primarily performed (in many cases these may be the same).  Please note that geographic information is not available for every record.</p>
            <div id="location-selector-text">Match locations by:</div><div id="location-selector">{{ form.location_type }}</div>
            
            <div class="clear-left"></div>
              <p class="select-all-or-none">[ <a href="#" class="select-all" id="location-selection-select-all">Select All</a> / <a href="#" class="select-none" id="location-selection-tag-select-none">Select None</a> ]</p>
            <div class="state-choices">


              {{ form.location_choices }}
            </div>
            <div class="clear-left"></div>
          </div>

            
            
            
          </fieldset>
          
          {% if ran_search %}
            <input type="button" id="reset-faads-search" value="Reset Search" />
            <script type="text/javascript" charset="utf-8">
            var original_url = window.location.href.replace(/\?.*$/,'');
            $(function(){ $('#reset-faads-search').click(function(){ window.location.href = original_url;})});
            </script>
          {% endif %}
          
          {{ form.sector_name }}
					<input type="submit" value="Search" name="submit-btn" class="faads-search-submit" />
          <div class="clear-right"></div>
          

					</form>
				
				    {% if not found_some_results and ran_search %}
				      <div id="no-faads-results-found">No records matching your search criteria were found</div>
				    {% endif %}
				    
			      {% if found_some_results and ran_search %}		
			      
			  <div class="ui-tabs ui-widget ui-widget-content ui-corner-all" id="tabs">
          		<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
          			<li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="#faads-result-table">Results</a></li>
          			<li class="ui-state-default ui-corner-top"><a href="#faads-result-graph">Summary</a></li>
          			<li class="ui-state-default ui-corner-top"><a href="#faads-result-map">By Location</a></li>
          			<li class="ui-state-default ui-corner-top"><a href="#faads-result-summary">By Program</a></li>                
          		</ul>
          		
          		<div class="ui-tabs-panel ui-widget-content ui-corner-bottom" id="faads-result-table">
			         			         
				      <table id="faads-search-results">
				        <thead>
				          <tr>
				            <th id="obligation_date" class="obligation-date">Obligation Date</th>
				            <th id="cfda_program" class="cfda-program">CFDA Program</th>
				            <th id="recipient" class="recipient-name">Recipient Name</th>
				            <th id="recipient_location" class="recipient-location">Recipient Location</th>
				            <th id="place_of_performance" class="place-of-performance">Place of Performance</th>
				            <th id="description" class="description">Description</th>
                    		<th id="amount" class="amount">Amount</th>                    
				          </tr>
				        </thead>

				        <tbody>
                {% for result in faads_results.object_list %}
                  <tr class="{% cycle "odd" "even" %}" rel="faads_record_id-{{ result.object.record_id }}">
                    <td class="obligation-date">{{ result.object.obligation_action_date }}</td>
                    <td class="cfda-program"><a href="/{{ sector }}/direct-expenditures/programs/{{ result.object.cfda_program.program_number }}/" title="{{ result.object.cfda_program.program_number }} {{ result.object.cfda_program.program_title }}">{{ result.object.cfda_program.program_number }}</a></td>
                    <td class="recipient-name">{{ result.object.recipient_name }}</td>
                    <td class="recipient-location">{{ result.object.recipient_city_name_for_display }}{% if result.object.recipient_city_name %}{% if result.object.recipient_state_name %},&nbsp;{% endif %}{% endif %}{{ result.object.recipient_state.abbreviation }}</td>
                    <td class="place-of-performance">{{ result.object.principal_place_county_or_city_name_for_display }}{% if result.object.principal_place_state %}{% if result.object.principal_place_county_or_city_name %},&nbsp;{% endif %}{% endif %}{{ result.object.principal_place_state.abbreviation }}</td>
                    <td class="description">{{ result.object.project_description }}</td>
                    <td class="amount last">${{ result.object.federal_funding_amount|floatformat:"-0"|intcomma }}</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>


              <div class="pagination">
                  <span class="step-links">                    
                    
                      {% if faads_results.has_previous %}
                          <a href="?q={{ query|safe }}&page=1{% if sort_column %}&s={{ sort_column }}{% endif %}{% if sort_order %}&o={{ sort_order }}{% endif %}">&laquo; first</a>
                          <a href="?q={{ query|safe }}&page={{ faads_results.previous_page_number }}{% if sort_column %}&s={{ sort_column }}{% endif %}{% if sort_order %}&o={{ sort_order }}{% endif %}">&lsaquo; prev</a>
                      {% else %}
                          <span class="disabled">&laquo; first</span>
                          <span class="disabled">&lsaquo; prev</span>
                      {% endif %}

                      <span class="current">
                          Page {{ faads_results.number|intcomma }} of {{ faads_results.paginator.num_pages|intcomma }}
                      </span>

                      {% if faads_results.has_next %}
                          <a href="?q={{ query|safe }}&page={{ faads_results.next_page_number }}{% if sort_column %}&s={{ sort_column }}{% endif %}{% if sort_order %}&o={{ sort_order }}{% endif %}">next &rsaquo;</a>
                          <a href="?q={{ query|safe }}&page={{ faads_results.paginator.num_pages }}{% if sort_column %}&s={{ sort_column }}{% endif %}{% if sort_order %}&o={{ sort_order }}{% endif %}">last &raquo;</a>
                      {% else %}
                          <span class="disabled">&raquo; next</span>
                          <span class="disabled">&rsaquo; last</span>
                      {% endif %}
                  </span>
              </div>

              <div class="pagination">
                  <span>
                      {% for page_num in page_range %}
                          <a href="?q={{ query|safe }}&page={{ page_num }}{% if sort_column %}&s={{ sort_column }}{% endif %}{% if sort_order %}&o={{ sort_order }}{% endif %}">{{ page_num }}</a>
                      {% endfor %}
                  </span>
              </div>
              
              <div class="search-disclaimer">{% morsel disclaimer1 %}</div>

              </div>
              
              <div class="ui-tabs-hide ui-widget-content ui-corner-bottom" id="faads-result-graph" >
                <span id="resultsgraph">
                		<p>To view this content, JavaScript must be enabled, and you need the latest version of the Adobe Flash Player.</p>
							
						<a href="http://www.adobe.com/go/getflashplayer" class="noHover" target="_top"><img src="{% media_url %}/images/get_flash_player.gif" alt="Get Adobe Flash Player" border="0" width="112" height="33"></a>
                </span>  
                
                {% js "scripts/json2.js" %}
                
                
                <div id="state-summary-container"><img id="ajax-loader" src="{% media_url %}/images/ajax-loader.gif" alt="Loading..." /></div>
                
                <script type="text/javascript" charset="utf-8">
                   
                   	var chartLoaded = false; 
                   	
                    function loadChartFlash()
                    {
                    	if(!chartLoaded)
                    		swfobject.embedSWF("/media/scripts/open-flash-chart.swf?v=2", "resultsgraph", "880", "400", "9.0.0", "expressInstall.swf", {'data-file': '{% url faads-search-by-year %}', 'data-query':'{{ query|safe }}'});
                    		
                    	chartLoaded = true;
                    	
                    	$.get('{% url faads-search-summary-state %}', { 'q': '{{ query|safe }}' }, function(data){
	                     $('#state-summary-container').html(data);
	                   });
                    }
                    
                </script>
              </div>
              
              <div class="ui-tabs-hide ui-widget-content ui-corner-bottom" id="faads-result-map">
    
    				
    
    				<script type="text/javascript" charset="utf-8">
    					
    					var mapLoaded = false;
    					
    					function loadMapFlash()
    					{
    						if(!mapLoaded)
		            			swfobject.embedSWF('{% media_url %}/scripts/SpendingMap.swf?v=9', 'mapVis', 800, 650, '9.0.0', '{% media_url %}/scripts/playerProductInstall.swf', {'mapPath':'/media/data/', 'dataPath':'{% url faads-search-map-data %}','dataQuery':'{{ query|safe }}'}, {wmode:'transparent'});
		  	              			
		            		mapLoaded = true;
		            		
			            	$.get('{% url faads-search-map-table %}', { 'q': '{{ query|safe }}' }, function(data){
		                     $('#map-summary-container').html(data);
		                   });
		    	        }	
    	              	
					</script>
            
		            <div style="text-align: center">
		          
		              <span id="map-year-range-label"><strong>{{ year_range_text|safe }}</strong></span>
		          
		            	<div style="float: right;  margin-right: 25px;">
		    						View: <select name="dataType">
		    							<option value="state">Total Spending</option>
		    							<option value="state_per_capital">Per Capita Spending </option>
		    						</select>
		              </div>
					</div>
					
					<br clear="all"/> 
					
					<div style="margin-left: 50px;">
						<div id="mapVis" >
							<p>To view this content, JavaScript must be enabled, and you need the latest version of the Adobe Flash Player.</p>
							
							<a href="http://www.adobe.com/go/getflashplayer" class="noHover" target="_top"><img src="{% media_url %}/images/get_flash_player.gif" alt="Get Adobe Flash Player" border="0" width="112" height="33"></a>
						
						</div>
					</div>
                  
                  	<div id="map-summary-container"><img id="ajax-loader" src="{% media_url %}/images/ajax-loader.gif" alt="Loading..." /></div>
                 

              </div>


              <div class="ui-tabs-hide ui-widget-content ui-corner-bottom" id="faads-result-summary">
                 <div id="program-summary-container"><img id="ajax-loader" src="{% media_url %}/images/ajax-loader.gif" alt="Loading..." /></div>
                 
                 <script type="text/javascript" charset="utf-8">
	                 function loadSummary()
	                 {
	                   $.get('{% url faads-search-summary-program %}', { 'q': '{{ query|safe }}' }, function(data){
	                     $('#program-summary-container').html(data);
	                   });
	                 }
                 </script>                 
              </div>


            </div>
            {% endif %}				
		</div>		
</div>

<form method="GET" action="" id="sortForm">
	<input name="q" value="{{ query|safe }}" type="hidden"/>
	<input id="sortField" name="s" value="" type="hidden"/>
	<input id="sortOrder" name="o" value="" type="hidden"/>
	<input id="sortPage" name="page" value="{{ faads_results.number }}" type="hidden"/>
</form>

{% endblock %}
